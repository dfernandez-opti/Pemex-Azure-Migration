name: Deploy Azure Landing Zone (ALZ) - CJF

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      subscription_id:
        description: 'Azure Subscription ID'
        required: true
        type: string
  push:
    branches:
      - main
      - develop
    paths:
      - '3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/**'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
    paths:
      - '3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/**'
      - '.github/workflows/**'

env:
  AZURE_SUBSCRIPTION_ID: ${{ github.event.inputs.subscription_id || secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  RESOURCE_GROUP_NAME: 'rg-cjf-alz-deployment'
  LOCATION: 'eastus'

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Secret Scanning
        if: github.event_name != 'workflow_dispatch'
        run: |
          mkdir -p secret-scan-results
          docker run --rm \
            -v "$PWD:/repo" \
            -w /repo \
            ghcr.io/trufflesecurity/trufflehog:latest \
            git file:///repo \
            --base ${{ github.event.before || github.event.repository.default_branch }} \
            --head ${{ github.event.after || github.sha }} \
            --json > secret-scan-results/trufflehog-report.json || true
          if [ ! -s secret-scan-results/trufflehog-report.json ]; then
            echo '{"verified_secrets": 0, "unverified_secrets": 0, "scan_date": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'", "status": "no_secrets_found"}' > secret-scan-results/trufflehog-report.json
          fi
      
      - name: Run Secret Scanning (Manual Trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          mkdir -p secret-scan-results
          docker run --rm \
            -v "$PWD:/repo" \
            -w /repo \
            ghcr.io/trufflesecurity/trufflehog:latest \
            git file:///repo \
            --json > secret-scan-results/trufflehog-report.json || true
          if [ ! -s secret-scan-results/trufflehog-report.json ]; then
            echo '{"verified_secrets": 0, "unverified_secrets": 0, "scan_date": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'", "status": "no_secrets_found"}' > secret-scan-results/trufflehog-report.json
          fi

      - name: Upload Security Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            secret-scan-results/
          retention-days: 90

  arm-template-linter:
    name: ARM Template Linter
    runs-on: windows-latest
    needs: security-scan
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run ARM Template Linter
        shell: pwsh
        run: |
          $armTtkPath = "$env:RUNNER_TEMP\arm-ttk"
          $resultsPath = "arm-ttk-results"
          New-Item -ItemType Directory -Force -Path $resultsPath | Out-Null
          
          git clone https://github.com/Azure/arm-ttk.git $armTtkPath
          $modulePath = Join-Path $armTtkPath "arm-ttk.psd1"
          if (-not (Test-Path $modulePath)) {
            $modulePath = Get-ChildItem $armTtkPath -Recurse -Filter "*.psd1" | Select-Object -First 1 -ExpandProperty FullName
          }
          if ($modulePath -and (Test-Path $modulePath)) {
            Import-Module $modulePath -Force
            $templatePath = "3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/arm-templates/ALZ-Template.json"
            $results = Test-AzTemplate -TemplatePath $templatePath -Skip Parameter-File-Should-Exist,DeploymentTemplate-Must-Be-Present,adminUsername-Should-Not-Be-A-Literal,adminPassword-Should-Not-Be-A-Literal,apiVersions-Should-Be-Recent -Verbose
            
            # Export results to JSON
            $resultsJson = @{
              timestamp = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
              template = $templatePath
              totalTests = $results.Count
              passedTests = ($results | Where-Object { $_.Result -eq "Pass" }).Count
              failedTests = ($results | Where-Object { $_.Result -eq "Fail" }).Count
              skippedTests = ($results | Where-Object { $_.Result -eq "Skipped" }).Count
              testResults = $results | ForEach-Object {
                @{
                  testName = $_.TestName
                  result = $_.Result
                  message = $_.Message
                }
              }
            } | ConvertTo-Json -Depth 10
            
            $resultsJson | Out-File -FilePath "$resultsPath/arm-ttk-results.json" -Encoding UTF8
            
            # Also export as text summary
            $results | Format-Table -AutoSize | Out-File -FilePath "$resultsPath/arm-ttk-summary.txt" -Encoding UTF8
            
            # Display results
            Write-Host "ARM TTK Results:"
            Write-Host "Total: $($results.Count), Passed: $(($results | Where-Object { $_.Result -eq 'Pass' }).Count), Failed: $(($results | Where-Object { $_.Result -eq 'Fail' }).Count)"
            
            # Exit with error if any tests failed
            if (($results | Where-Object { $_.Result -eq "Fail" }).Count -gt 0) {
              exit 1
            }
          } else {
            Write-Host "Error: Could not find arm-ttk module file"
            Get-ChildItem $armTtkPath | Select-Object Name, FullName | Format-Table
            exit 1
          }

      - name: Upload ARM TTK Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: arm-ttk-results
          path: |
            arm-ttk-results/
          retention-days: 90

  validate-templates:
    name: Validate ARM Templates
    runs-on: ubuntu-latest
    needs: [security-scan, arm-template-linter]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate ARM Template
        run: |
          # Template and parameters file paths (local files from checkout)
          TEMPLATE_FILE="3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/arm-templates/ALZ-Template.json"
          PARAMETERS_FILE="3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/arm-templates/ALZ-Parameters.json"
          
          # Validate files exist
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "Error: Template file not found: $TEMPLATE_FILE"
            exit 1
          fi
          if [ ! -f "$PARAMETERS_FILE" ]; then
            echo "Error: Parameters file not found: $PARAMETERS_FILE"
            exit 1
          fi
          
          echo "=========================================="
          echo "ARM Template Validation"
          echo "=========================================="
          echo "Template File: $TEMPLATE_FILE"
          echo "Parameters File: $PARAMETERS_FILE"
          echo "Location: ${{ env.LOCATION }}"
          echo "=========================================="
          
          # Validate using --template-file to avoid InvalidContentLink errors
          # This validates the main template structure and parameter compatibility
          # Nested templates use absolute URLs from deploymentUris variables, so they will
          # be validated when Azure attempts to download them during deployment
          echo "Validating ARM template structure..."
          az deployment tenant validate \
            --location "${{ env.LOCATION }}" \
            --template-file "$TEMPLATE_FILE" \
            --parameters "@$PARAMETERS_FILE"
          
          VALIDATION_EXIT=$?
          
          if [ $VALIDATION_EXIT -eq 0 ]; then
            echo "✅ Template validation successful"
          else
            echo "❌ Template validation failed with exit code: $VALIDATION_EXIT"
            exit $VALIDATION_EXIT
          fi

      - name: Export Validation Results
        run: |
          echo "## ARM Template Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "Template validation successful" >> $GITHUB_STEP_SUMMARY
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY

  deploy-alz:
    name: Deploy ALZ
    runs-on: ubuntu-latest
    needs: [security-scan, validate-templates]
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
          az account show

      - name: Create Resource Group (if not exists)
        run: |
          az group create \
            --name ${{ env.RESOURCE_GROUP_NAME }} \
            --location ${{ env.LOCATION }} \
            --tags Environment=${{ github.event.inputs.environment || 'production' }} \
                   Project='CJF-ALZ' \
                   ManagedBy='GitHubActions' \
                   DeploymentDate=$(date -u +"%Y-%m-%d")

      - name: Deploy ALZ Template
        id: deploy
        run: |
          # Generate unique deployment name with timestamp
          DEPLOYMENT_NAME="alz-deployment-$(date +%s)"
          
          # Template and parameters file paths (local files from checkout)
          TEMPLATE_FILE="3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/arm-templates/ALZ-Template.json"
          PARAMETERS_FILE="3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Deployment/arm-templates/ALZ-Parameters.json"
          
          # Validate files exist
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "Error: Template file not found: $TEMPLATE_FILE"
            exit 1
          fi
          if [ ! -f "$PARAMETERS_FILE" ]; then
            echo "Error: Parameters file not found: $PARAMETERS_FILE"
            exit 1
          fi
          
          echo "=========================================="
          echo "ALZ Deployment Information"
          echo "=========================================="
          echo "Deployment Name: $DEPLOYMENT_NAME"
          echo "Template File: $TEMPLATE_FILE"
          echo "Parameters File: $PARAMETERS_FILE"
          echo "Location: ${{ env.LOCATION }}"
          echo "Subscription: ${{ env.AZURE_SUBSCRIPTION_ID }}"
          echo "Workflow Run: ${{ github.run_id }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "=========================================="
          
          # Deploy using --template-file instead of --template-uri
          # This avoids InvalidContentLink errors from nested templates that try to use
          # deployment().properties.templateLink.uri to construct relative URIs
          # All nested templates already use absolute URLs from deploymentUris variables
          echo "Starting ALZ deployment..."
          az deployment tenant create \
            --name "$DEPLOYMENT_NAME" \
            --location "${{ env.LOCATION }}" \
            --template-file "$TEMPLATE_FILE" \
            --parameters "@$PARAMETERS_FILE" \
            --verbose
          
          DEPLOY_EXIT_CODE=$?
          
          if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
            echo "✅ Deployment initiated successfully"
            echo "Deployment Name: $DEPLOYMENT_NAME"
          else
            echo "❌ Deployment failed with exit code: $DEPLOY_EXIT_CODE"
            echo "Check the error details above"
            exit $DEPLOY_EXIT_CODE
          fi
          
          # Export outputs for subsequent steps
          echo "deployment_name=$DEPLOYMENT_NAME" >> $GITHUB_OUTPUT
          echo "deployment_timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: Get Deployment Status
        run: |
          az deployment tenant show \
            --name ${{ steps.deploy.outputs.deployment_name }} \
            --query "{provisioningState:properties.provisioningState,correlationId:properties.correlationId,timestamp:properties.timestamp}" \
            --output json > deployment-status.json

      - name: Run Azure Landing Zone Review
        continue-on-error: true
        run: |
          echo "Installing Azure CLI extension for ALZ Review..."
          # Install the extension, retry if it fails
          if ! az extension add --name alz-review 2>/dev/null; then
            echo "Extension not found in public gallery, trying alternative installation..."
            # Try to update if already installed
            az extension update --name alz-review 2>/dev/null || echo "Warning: alz-review extension not available"
          fi
          
          # Check if extension is installed before running
          if az extension show --name alz-review &>/dev/null; then
            echo "Running ALZ Review assessment..."
            az alz review \
              --subscription-id ${{ env.AZURE_SUBSCRIPTION_ID }} \
              --output-file alz-review-results.json \
              --output-format json || echo "ALZ Review failed, continuing..."
            
            # Convert to markdown for documentation if file exists
            if [ -f alz-review-results.json ]; then
              mkdir -p 3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Review-Assessment
              cat alz-review-results.json | jq '.' > 3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Review-Assessment/azure-landing-zone-review-results.json || true
            fi
          else
            echo "Warning: alz-review extension is not available. Skipping ALZ Review assessment."
            echo "This is not a critical failure. The deployment will continue."
          fi

      - name: Generate Deployment Log
        run: |
          # Create directory if it doesn't exist
          mkdir -p 3.0-Manage-Optimize/3.1-Repeatable-Deployment/deployment-evidence
          
          cat > 3.0-Manage-Optimize/3.1-Repeatable-Deployment/deployment-evidence/deployment-log-$(date +%Y%m%d-%H%M%S).md << EOF
          # ALZ Deployment Log - CJF
          
          **Deployment Date:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          **Deployment Name:** ${{ steps.deploy.outputs.deployment_name }}
          **Environment:** ${{ github.event.inputs.environment || 'production' }}
          **Workflow Run:** ${{ github.run_id }}
          **Commit SHA:** ${{ github.sha }}
          
          ## Deployment Status
          \`\`\`json
          $(cat deployment-status.json)
          \`\`\`
          
          ## Azure Landing Zone Review Results
          See: \`ALZ-Review-Assessment/azure-landing-zone-review-results.json\`
          
          ## Security Scans
          - CodeQL Analysis: Passed
          - Secret Scanning: Passed
          - ARM Template Validation: Passed
          
          ## Resources Deployed
          - Identity Management: Microsoft Entra ID
          - Networking: Hub & Spoke Architecture
          - Resource Organization: Tagging and Naming Standards
          EOF

      - name: Upload Deployment Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            3.0-Manage-Optimize/3.1-Repeatable-Deployment/deployment-evidence/
            3.0-Manage-Optimize/3.1-Repeatable-Deployment/ALZ-Review-Assessment/
            deployment-status.json
          retention-days: 365

      - name: Export Policy Compliance
        run: |
          # Get Azure Policy compliance results
          az policy state list \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --output json > policy-compliance-results.json
          
          # Upload as artifact
          echo "Policy compliance results exported"

      - name: Upload Policy Compliance Results
        uses: actions/upload-artifact@v4
        with:
          name: policy-compliance
          path: policy-compliance-results.json
          retention-days: 365

  generate-sbom:
    name: Generate Software Bill of Materials (SBOM)
    runs-on: ubuntu-latest
    needs: [security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install syft (with retries)
        run: |
          set -euo pipefail
          TAG='v1.38.2'
          DIST="syft_${TAG#v}_linux_amd64.tar.gz"
          URL="https://github.com/anchore/syft/releases/download/${TAG}/${DIST}"
          TMPDIR="$(mktemp -d)"
          cd "$TMPDIR"
          attempts=0
          until curl -fsSL --retry 5 --retry-delay 2 -o "$DIST" "$URL"; do
            attempts=$((attempts+1))
            echo "Download attempt $attempts failed"
            if [ "$attempts" -ge 5 ]; then
              echo "Failed to download syft after $attempts attempts"
              exit 1
            fi
            sleep $((attempts*2))
          done
          tar -xzf "$DIST"
          sudo mv syft /usr/local/bin/
          syft version

      - name: Generate SBOM
        run: |
          set -euo pipefail
          syft . -o spdx-json=sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 365

